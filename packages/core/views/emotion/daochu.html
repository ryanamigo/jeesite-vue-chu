<!DOCTYPE html>
<% layout('/layouts/default.html', {title: 'emotion_result管理', libs: ['dataGrid']}){ %>
<html lang="en">
<head>
    <meta charSet="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0,user-scalable=no">
    <title>Title</title>
    <!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
    <script src="/js/static/jquery/jquery-3.7.0.min.js"></script>
    <!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
    <script src="${ctxStatic}/js/bootstrap.min.js"></script>
    <!-- 新 Bootstrap 核心 CSS 文件 -->
    <link rel="stylesheet" type="text/css" href="${ctxStatic}/css/bootstrap.css">
    <script src="${ctxStatic}/js/toastr.min.js"></script>
    <link href="${ctxStatic}/css/toastr.min.css" rel="stylesheet">
<!--    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>-->
    <script src="${ctxStatic}/js/sweetalert.js"></script>
</head>
<style>
    body {
        height: 100vh; /* Changed from 100% to 100vh to ensure it takes the full viewport height */
        width: 100%;
        margin: 0;
        padding: 0;
        background: url('/js/static/image/win2.jpg') no-repeat center center;
        background-size: cover;
        background-attachment: fixed;
    }

    .content {
        height: 100%;
        width: 98%;
        margin: 0 auto;
        padding-top: 3px;
    }

    /*425start*/
    #panel {
        width: 100%;
        height: 100%;
        background-color: #000;
        opacity: 0.4;
        /*解决IE兼容透明度*/
        filter: alpha(opacity:40);
        position: absolute;
        left: 0;
        top: 0;
        display: none;
    }

    #login {
        width: 50%;
        height: 45%;
        background: #1a1a1a;
        -webkit-border-radius: 5px;
        -moz-border-radius: 5px;
        border-radius: 5px;
        position: fixed;
        left: 40%;
        top: 40%;
        margin: -150px 0 0 -150px;
        display: none;
        border: 1px solid black; /* 设置边框宽度为2px，样式为实线，颜色为黑色 */
        padding: 10px; /* 添加内边距以避免内容紧贴边框 */
    }

    #userMarking {
        background-color: #262626;
        color: rgba(255, 255, 255, 0.8);
        position: relative;
        max-width: 79%;
        top: 5%;
        left: 9.5%;
        width: 80%;
        height: 70%;
        white-space: pre-wrap;
        word-break: break-word;
        border: 0;
        outline: 0;
        border: solid 1px #494640;
        box-shadow: 0 0 10px #3c8dbc;
        border-radius: 4px;
        background-color: transparent;
    }

    #manage button {
        margin: 5px;
        border-radius: 10px;
        border: 0;
        color: white;
        cursor: pointer; /* 显示鼠标指针为手型 */
        font-size: 18px;
        height: 100%;
        width: 6%;
        align-items: center; /* 垂直居中 */
        justify-content: center; /* 水平居中 */  //530
    }

    button:active {
        transform: translateY(2px); /* 按下时按钮向下移动2px */
    }

    .yesOrNo {
        position: relative;
        top: 80%;
        /*height: 100%;*/
        border: 0;
        border-radius: 22px;
        background-color: #494640;
        box-shadow: 0 0 15px #97bdd4;
        color: #FFFFFF;
        font-size: 15px;
        margin-left: 25px;
    }

    #yes {
        position: relative;
        left: 15%;
        width: 20%;
        background-color: #1e5edb;
        color: rgba(255, 255, 255, 0.8);
    }

    #no {
        position: relative;
        left: 30%;
        width: 20%;
        background-color: #444444;
        color: rgba(255, 255, 255, 0.8);
    }

    /* 创建圆形的外观 */
    #batchOperations label {
        display: inline-block;
        width: 100%;
        height: 100%;
        background-color: #fff;
        border: 2px solid #666;
        border-radius: 50%;
        cursor: pointer;
        position: relative;
    }





    /* 选中状态的样式 */

    input[type=checkbox] {
        cursor: pointer;
        position: relative;
        width: 15px;
        height: 15px;
        font-size: 14px;
    }

    input[type=checkbox]::after {
        position: absolute;
        top: 0;
        color: #000;
        width: 15px;
        height: 15px;
        display: inline-block;
        visibility: visible;
        padding-left: 0px;
        text-align: center;
        content: ' ';
        border-radius: 3px
    }

    input[type=checkbox]:checked::after {
        content: "✓";
        color: #fff;
        font-size: 12px;
        font-weight: bold;
        background-color: #fa9700;
    }

    /*#batchOperations input[type="checkbox"]:checked + label::after {*/
    /*    content: '';*/
    /*    position: absolute;*/
    /*    top: 50%;*/
    /*    left: 50%;*/
    /*    transform: translate(-50%, -50%);*/
    /*    width: 12px;*/
    /*    height: 12px;*/
    /*    border-radius: 50%;*/
    /*    background: #337ab7;*/
    /*}*/

    /*425end*/
    .table_box {
        width: 98%;
        margin: 1vh auto 0;
        font-size: 11px;
        color: #ffffff;
        border: 0;
    }

    .tr_header {
        height: 7vh;
    }

    .table_box th {
        font-size: 23px;
        box-shadow: inset 0 0 10px #4487d5;
        border: 0;
        border-radius: 50px;
        text-align: center
    }

    .table_box td {
        border: 0;
    }

    .oddrowcolor {
        box-shadow: inset 0px 0px 13px #4487d5;
        height: 5vh;
        border: 0;
        border-radius: 24px;
        font-size: 16px;
    }

    .evenrowcolor {
        background-color: transparent;
        height: 5vh;
        font-size: 16px;
    }

    .batch {
        float: right;
    }
</style>
<body>
<div class="content">
    <!--    530-->
    <div id="manage" style="position: relative;height: 6vh;width: 100%;">
        <img src="${ctxStatic}/images/ksh33.png" style="  display: flex;float:left;width: 50%;">
        <button class="batch" id="checkAll" style="background-color: #fa9700 ;margin-right: 4vh;">全&emsp;选</button>
        <button class="batch" id="batchExport" style="background-color: #00a55a">批量导出</button>
        <button class="batch" id="batchDelete" style="background-color: #dd4b39">批量删除</button>
    </div>
    <!--    530-->
    <table class="table_box" id="table_box">
        <tr class="tr_header">
            <th>序号</th>
            <th>姓名</th>
            <th>性别</th>
            <th>编号</th>
            <th>部别</th>
            <th>测试时间</th>
            <th>操作</th>
            <th>导出报告</th>
            <th>管理</th>
        </tr>
        <tbody class="tbody_body" id="tbody_body">
        </tbody>
    </table>
</div>
<!--425start-->
<div id="panel"></div>
<div id="login">
    <input type="text" id="userMarking" placeholder="请输入注释">
    <div id="yesAndNo">
        <button id="yes" class="yesOrNo">确定</button>
        <button id="no" class="yesOrNo">取消</button>
    </div>
</div>
<!--425end-->
</body>
</html>
<% } %>
<!--425start-->
<script>
    toastr.options = {
        positionClass: 'toast-bottom-right'
    };
    var searchVideoBtn;
    // 从localStorage中获取存储的数据
    var storedData = localStorage.getItem('key');
    if (storedData) {
        var parsedData = JSON.parse(storedData);
        var dataFiltered = parsedData.data;
        var gender = String(dataFiltered.gender);
        var startTime = String(dataFiltered.startTime);
        var endTime = String(dataFiltered.endTime);
        var startAge = String(dataFiltered.startAge);
        var endAge = String(dataFiltered.endAge);
        var companyCode = String(dataFiltered.companyCode);
        var companyName = String(dataFiltered.companyName);
        var testNumbers;
        if (dataFiltered.testNumbers && dataFiltered.testNumbers.length === 0) {
            testNumbers = [];
        } else {
            testNumbers = dataFiltered.testNumbers ? dataFiltered.testNumbers.split(',') : [];
        }
        var type = 2; // 可根据需求设置type的值
        let formData = new FormData();
        formData.append('type', type);
        formData.append('gender', gender);
        formData.append('startTime', startTime);
        formData.append('endTime', endTime);
        formData.append('startAge', startAge);
        formData.append('endAge', endAge);
        formData.append('testNumbers', testNumbers);
        formData.append('companyCode', companyCode);
        formData.append('companyName', companyName);
        $(document).ready(function () {
            //判断登录账号类别
            var accountClass;
            $.ajax({
                url: '${ctx}/judgmentAccount',
                type:'POST',
                success:function (data){
                    accountClass = data;
                },
                error: function(xhr, status, error) {
                    console.log("请求失败: " + error);
                }
            })


            var tbody = window.document.getElementsByClassName("tbody_body")[0]; // 获取tbody元素
            // 发送Ajax请求调用后端Controller的findDataByPsychology方法
            $.ajax({
                url: '${ctx}/subject/subjectInformation/findInfomByType' ,
                type: 'POST',
                processData: false,
                contentType: false,
                data: formData,
                success: function (response) {
                    // 进行数据展示或其他操作
                    var str = "";
                    for (var i = 0; i < response.length; i++) {
                        var pname = response[i].pname;
                        var pidcard = response[i].pidcard;
                        var pgender = response[i].pgender;
                        var age = response[i].age;
                        var pposition = response[i].pposition;
                        var ppositionName = response[i].ppositionName;
                        var sid = response[i].sid;
                        var rowColorClass = (i % 2 === 0) ? 'evenrowcolor' : 'oddrowcolor'; // Determine row color class
                        str += "<tr class='" + rowColorClass + "'>" +
                            "<td align='center'>" + (i + 1) + "</td>" +
                            "<td align='center'>" + pname + "</td>" +
                            "<td align='center'>" + pgender + "</td>" +
                            "<td align='center'>" + pidcard + "</td>" +
                            "<td align='center'>" + ppositionName + "</td>" +
                            "<td align='center'>" + response[i].createdAt + "</td>" +
                            // "<td align='center'>" + "<a href='${ctx}/emotion/emotionResult/checkVideoForm?pidcard = " + pidcard + "'  id='searchVideo-" + sid + "' style='color: #d7d717' title='" + pname + "视频'  class='addTabPage'><i class=\"icon-social-youtube\" >查看</i></a>" + "</td>" +
                            "<td align='center'>" +
                            "<a id='detail-" + pidcard + "' href='${ctx}/subject/subjectInformation/form?pidcard=" + pidcard + "&pname=" + pname + "&pgender=" + pgender + "&ppositionName=" + ppositionName + "&age=" + age + "&sid=" + sid + "' title='" + pname + "详情' class='addTabPage' style='color:#00f2ff;'><i class=\"icon-list\" >详情</i></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;" +
                            "<a id='deleteInfo-" + pidcard + "'  class='btnList' style='color: #dd4b39;cursor: pointer;' title='${text('删除')}'><i class=\"fa fa-trash-o\" >删除</i></a>" +
                            "</td>" +
                            "<td align='center'>" +
                            "<a class='PreventDuplication'  id='exportInfo-" + sid + "' style='color: #00a45a;cursor: pointer;' title='${text('导出报告')}'><i class=\"icon-link\">导出报告</i></a>" +
                            "</td>" +
                            "<td align='center'>" +
                            "<input type=\"checkbox\" id='batchOperations" + sid + "' data-pidcard='" + pidcard + "'  data-pname='" + pname + "' style='cursor: pointer;'>" +
                            "</td>" +
                            "</tr>";
                    }

                    tbody.innerHTML = str; // 将数据写入tbody的innerHTML中
           //         禁用函数
           function disable(data){
               data.href = '#';
               data.style.color = 'gray';
               data.style.cursor = 'not-allowed';
               data.disabled = true;
            }
                    //判断账号类别，如果是采集账号使得后面的<a>标签禁用
                    if(accountClass === "采集账号"){
                        disable(document.getElementById('checkAll' ));
                        disable(document.getElementById('batchExport' ));
                        disable(document.getElementById('batchDelete' ));
                        document.getElementById('checkAll' ).style.backgroundColor = 'white';
                        document.getElementById('batchExport' ).style.backgroundColor = 'white';
                        document.getElementById('batchDelete' ).style.backgroundColor = 'white';
                        for (let i = 0; i < response.length; i++) {
                            disable(document.getElementById('deleteInfo-' + response[i].pidcard));
                            disable(document.getElementById('detail-' + response[i].pidcard));
                            disable(document.getElementById('exportInfo-' + response[i].sid));
                            disable(document.getElementById('batchOperations' + response[i].sid));
                            // document.getElementById('deleteInfo-' + response[i].pidcard).addEventListener('click', function(event) {
                            //     event.preventDefault(); // 阻止链接跳转
                            // });
                        }

                    } else{
                    //点一次全选，再点一次取消全选
                    var button3 = document.getElementById('checkAll');// 为按钮添加点击事件监听器
                    var flag = false;//标志位，如果为真，就取消全选
                    button3.addEventListener('click', function () {
                            for (let j = 0; j < response.length; j++) {
                                checkbox = document.getElementById('batchOperations' + response[j].sid);
                                if (flag) {
                                    checkbox.checked = false;
                                }else{
                                    checkbox.checked = true;
                                }
                            }
                        flag = !flag;
                    })

                    //    425start 操作标注
                    for (let i = 0; i < response.length; i++) {
                        //查看视频
                        searchVideoBtn = document.getElementById('searchVideo-');

                        //批量导出按钮
                        //获取按钮元素
                        var button1 = document.getElementById('batchExport');// 为按钮添加点击事件监听器
                        button1.addEventListener('click', function () {
                            // 这里是当按钮被按下时要执行的代码
                            //获取表单中的checkbox是否被选中
                            var checkbox = document.getElementById('batchOperations' + response[i].sid);
                            if (checkbox.checked) {
                                //导出报告
                                document.getElementById('exportInfo-' + response[i].sid).innerHTML = '<i class=" icon-refresh" style="cursor: pointer">正在导出</i>'
                                // 禁用超链接防止重复提交下载 disabled和events必须一起使用
                                $(".PreventDuplication").attr("disabled", true).css("pointer-events", "none");
                                let xhr = new XMLHttpRequest();
                                xhr.open('GET', '${ctx}/subject/resultExport/pidcardExportExcel?pidcard=' + response[i].pidcard, true);
                                xhr.responseType = 'blob';
                                // 处理响应结果
                                xhr.onload = function () {
                                    if (this.status === 200) {
                                        var blob = new Blob([this.response], {type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
                                        var link = document.createElement('a');
                                        link.href = window.URL.createObjectURL(blob);
                                        link.download = response[i].pidcard + '-' + response[i].pname + '-' + '导出报告.xlsx';
                                        link.click();
                                        //下载完成恢复超链接
                                        $(".PreventDuplication").attr("disabled", false).css("pointer-events", "auto");
                                        setTimeout(function () {
                                            document.getElementById('exportInfo-' + response[i].sid).innerHTML = '<i class=" icon-link" style="cursor: pointer">导出报告</i>'
                                        }, 1100)
                                        document.getElementById('exportInfo-' + response[i].sid).innerHTML = '<i class=" icon-link" id="fade" style="cursor: pointer">导出成功</i>'
                                        $('#fade').fadeOut(1000)
                                    }
                                };
                                xhr.send(null);
                            }
                        })

                        //批量删除按钮
                        //获取按钮元素
                        var button2 = document.getElementById('batchDelete');// 为按钮添加点击事件监听器
                        button2.addEventListener('click', function () {
                            // 这里是当按钮被按下时要执行的代码
                            //获取表单中的checkbox是否被选中
                            var checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
                            if (checkboxes.length === 0) {
                                toastr.info('请选择要删除的记录');
                                return;
                            }

                            Swal.fire({
                                title: '确认要删除选中的人员信息吗？',
                                icon: 'warning',
                                showCancelButton: true,
                                confirmButtonColor: '#3085d6',
                                cancelButtonColor: '#d33',
                                confirmButtonText: '是的，删除它！',
                                cancelButtonText: '取消'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    deleteNext(0); // 开始递归删除
                                }
                            });

                            function deleteNext(index) {
                                if (index < checkboxes.length) {
                                    var pidcard = checkboxes[index].getAttribute('data-pidcard'); // 获取pidcard
                                    var pname = checkboxes[index].getAttribute('data-pname'); // 获取pidcard

                                    $.ajax({
                                        url: '${ctx}/emotion/emotionResult/deleteSubjectInformation',
                                        type: 'POST',
                                        data: {pidcards: pidcard}, // 发送单个pidcard
                                        success: function (response) {
                                            toastr.success('成功删除' + pname + '的人员信息!');
                                            deleteNext(index + 1); // 递归调用删除下一个
                                        },
                                        error: function () {
                                            toastr.error('删除失败: ' + pname);
                                            deleteNext(index + 1); // 即使失败也继续尝试删除下一个
                                        }
                                    });
                                } else {
                                    location.reload(); // 所有删除尝试完成后重新加载页面
                                }
                            }
                        });
                        //  单个删除按钮  ljh
                        var deleteInfoElement = document.getElementById('deleteInfo-' + response[i].pidcard); // 获取删除按钮元素
                        deleteInfoElement.addEventListener('click', function () {
                            var pname = response[i].pname;
                            var pidcard = response[i].pidcard;

                            Swal.fire({
                                title: '确认要删除' + pname + '的人员信息吗？',
                                text: "此操作不可撤销",
                                icon: 'warning',
                                showCancelButton: true,
                                confirmButtonColor: '#3085d6',
                                cancelButtonColor: '#d33',
                                confirmButtonText: '是的，删除它！',
                                cancelButtonText: '取消'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    $.ajax({
                                        url: '${ctx}/emotion/emotionResult/deleteSubjectInformation',
                                        type: 'POST',
                                        data: {pidcards: pidcard}, // 发送单个pidcard
                                        success: function (response) {
                                            toastr.success('成功删除' + pname + '的人员信息!');
                                            location.reload(); // 重新加载页面
                                        },
                                        error: function (xhr, status, error) {
                                            toastr.error('删除失败: ' + error);
                                        }
                                    });
                                }
                            });
                        });

                        //导出报告
                        var exportInfoElement = document.getElementById('exportInfo-' + response[i].sid)
                        // 添加点击事件监听器
                        exportInfoElement.addEventListener('click', function () {
                            document.getElementById('exportInfo-' + response[i].sid).innerHTML = '<i class=" icon-refresh" style="cursor: pointer">正在导出</i>'
                            // 禁用超链接防止重复提交下载 disabled和events必须一起使用
                            $(".PreventDuplication").attr("disabled", true).css("pointer-events", "none");
                            //使用XMLHttpRequest发送一个GET请求
                            let xhr = new XMLHttpRequest();
                            xhr.open('GET', '${ctx}/subject/resultExport/pidcardExportExcel?pidcard=' + response[i].pidcard, true);
                            //服务器返回的数据是二进制文件
                            xhr.responseType = 'blob';
                            // 处理响应结果
                            xhr.onload = function () {
                                //服务器返回的状态码是200，表示请求成功
                                if (this.status === 200) {
                                    //将服务器响应的数据转为一个Blob对象，指定其类型为excel文档
                                    // var blob = new Blob([this.response], {type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'});
                                    var blob = new Blob([this.response], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                                    // 创建一个 <a> 元素用于下载
                                    var link = document.createElement('a');
                                    // 为 <a> 元素创建一个指向 blob 对象的 URL
                                    link.href = window.URL.createObjectURL(blob);
                                    // 设置下载的文件名，这里 response[i] 是一个包含文件命名信息的对象
                                    // 注意：确保文件名具有正确的 .xlsx 扩展名
                                    link.download = response[i].pidcard + '-' + response[i].pname + '-' + '导出报告.xlsx';
                                    // 触发 <a> 元素的点击事件以下载文件
                                    link.click();
                                    //下载完成恢复超链接
                                    $(".PreventDuplication").attr("disabled", false).css("pointer-events", "auto");
                                    setTimeout(function () {
                                        document.getElementById('exportInfo-' + response[i].sid).innerHTML = '<i class=" icon-link" style="cursor: pointer">导出报告</i>'
                                    }, 1100)
                                    document.getElementById('exportInfo-' + response[i].sid).innerHTML = '<i class=" icon-link" id="fade" style="cursor: pointer">导出成功</i>'
                                    $('#fade').fadeOut(1000)
                                }
                            };
                            xhr.send(null);
                        })
                    }}
                    //    425end
                },
                error: function (xhr, status, error) {
                    console.log("请求失败: " + error);
                }
            });
        });
    } else {
        console.log('localStorage中没有存储的数据');
    }

</script>
<!--425end-->