<% layout('/layouts/default.html', {title: 'emotion_subject管理', libs: ['dataGrid']}){ %>
  <style>
    button {
      cursor: pointer; /* 显示鼠标指针为手型 */
    }
    button:active {
      transform: translateY(2px); /* 按下时按钮向下移动2px */
    }
    #panel{
      width:100%;
      height:100%;
      background-color:#000;
      opacity:0.4;
      /*解决IE兼容透明度*/
      filter: alpha(opacity:40);
      position:absolute;
      left:0;
      top:0;
      display:none;
      z-index: 9999
    }
  
    #login{
      width:50%;
      height:45%;
      background: #1a1a1a;
      -webkit-border-radius: 5px;
      -moz-border-radius: 5px;
      border-radius: 5px;
      position: fixed;
      left:40%;
      top:40%;
      margin: -150px 0 0 -150px;
      display:none;
      border: 1px solid black; /* 设置边框宽度为2px，样式为实线，颜色为黑色 */
      padding: 10px; /* 添加内边距以避免内容紧贴边框 */
      z-index: 9999
    }
  
    #yesAndNo{
      position: relative;
      top: 10%;
    }
    #userMarking{
      background-color: #262626;
      color: rgba(255, 255, 255, 0.8);
      position: relative;
      max-width: 79%;
      top: 5%;
      left: 9.5%;
      width: 80%;
      height: 70%;
      white-space: pre-wrap;
      word-break: break-word;
      border:0;
      outline:0;
      border: solid 1px #494640;
      box-shadow: 0 0 10px #3c8dbc;
      border-radius: 4px;
      background-color:transparent;
    }
    .yesOrNo{
      position: relative;
      top: 80%;
      /*height: 100%;*/
      border:0;
      border-radius: 22px;
      background-color:#494640;
      box-shadow: 0 0 15px #97bdd4;
      color:#FFFFFF;
      font-size: 15px;
      margin-left: 25px;
    }
    #yes{
      position: relative;
      left: 15%;
      width: 20%;
      background-color: #1e5edb;
      color: rgba(255, 255, 255, 0.8);
    }
    #no{
      position: relative;
      left: 30%;
      width: 20%;
      background-color: #444444;
      color: rgba(255, 255, 255, 0.8);
    }
    .hidden {
      display: none;
    }
    #untestedPeopleMask{
      width:50%;
      height:80%;
      background: #1a1a1a;
      -webkit-border-radius: 5px;
      -moz-border-radius: 5px;
      border-radius: 5px;
      position: fixed;
      left:40%;
      top:30%;
      margin: -150px 0 0 -150px;
      display:none;
      border: 1px solid black; /* 设置边框宽度为2px，样式为实线，颜色为黑色 */
      padding: 10px; /* 添加内边距以避免内容紧贴边框 */
      z-index: 9999
    }
    #untestButton{
      position: relative;
      top: 10%;
    }
    .untestButton{
      position: relative;
      top: 80%;
      /*height: 100%;*/
      border:0;
      border-radius: 22px;
      background-color:#494640;
      box-shadow: 0 0 15px #97bdd4;
      color:#FFFFFF;
      font-size: 15px;
      margin-left: 25px;
    }
  
    #untestCansel{
      position: relative;
      left: 35%;
      width: 20%;
      background-color: #444444;
      color: rgba(255, 255, 255, 0.8);
    }
    #untestTree {
      width: 90%;
      height: 85%;
      background-color: #262626;
      display: block;
      margin-left: 5%;
      max-height: 85%; /* 设置最大高度，超出部分将显示滚动条 */
      overflow: auto; /* 显示滚动条 */
      border:0;
      outline:0;
      /* border: solid 1px #494640; */
      /* box-shadow: 0 0 10px #3c8dbc; */
      border-radius: 4px;
      background-color:transparent;
    }
    #maskTable {
      width: 98%;
      margin: 1vh auto 0;
      font-size: 11px;
      border: 0;
      border-collapse: separate; /* 使用独立的边框模型 */
      border-spacing: 10px; /* 设置表格单元格之间的间距为10px */
    }
    #maskTable td {
      padding: 5px; /* 设置表格单元格的内边距为5px */
      border: 0;
    }
    #maskTable th {
      font-size: 23px;
      box-shadow: inset 0 0 10px #4487d5;
      border: 0;
      border-radius: 50px;
      text-align: center
    }
    .oddrowcolor {
      box-shadow: inset 0px 0px 13px #4487d5;
      height: 5vh;
      border: 0;
      border-radius: 24px;
      font-size: 16px;
    }
  
    .evenrowcolor {
      background-color: transparent;
      height: 5vh;
      font-size: 16px;
    }
  
  </style>
  <div class="main-content">
    <div class="box box-main">
      <div class="box-header">
        <div class="box-title">
          <i class="fa icon-notebook"></i> ${text('任务管理')}
        </div>
        <div class="box-tools pull-right">
          <a href="#" class="btn btn-default" id="btnSearch" title="${text('查询')}"><i class="fa fa-filter"></i> ${text('查询')}</a>
          <a href="#" class="btn btn-default" id="btnSetting" title="${text('设置')}"><i class="fa fa-navicon"></i></a>
        </div>
      </div>
      <div class="box-body" >
        <#form:form id="searchForm" model="${resultInformation}" action="${ctx}/result/resultInformation/listData1" method="post" class="form-inline"
        data-page-no="${parameter.pageNo}" data-page-size="${parameter.pageSize}" data-order-by="${parameter.orderBy}">
        <div class="form-group" style="width: 13%">
          <label class="control-label">${text('编号')}：</label>
          <div class="control-inline" style="width: 69%">
            <#form:input path="pidcard" maxlength="18" class="form-control" style="width:100%;"/>
          </div>
        </div>
        <div class="form-group" style="width: 13%">
          <label class="control-label">${text('姓名')}：</label>
          <div class="control-inline" style="width: 69%">
            <#form:input path="pname" maxlength="20" class="form-control" style="width:100%;"/>
          </div>
        </div>
        <div class="form-group" style="width: 8%">
          <label class="control-label">${text('性别')}：</label>
          <div class="control-inline" style="width: 50%">
            <#form:input path="pgender" maxlength="＇男＇" class="form-control"  style="width:100%;"/>
          </div>
        </div>
        <div class="form-group" style="width: 12%">
          <label class="control-label">${text('部别')}：</label>
          <div class="control-inline " style="width: 60%">
            <#form:treeselect id="ppositionName" title="${text('部别选择')}"
            style="width:89px;"
            path="pposition" labelPath="ppositionName"
            url="${ctx}/sys/company/treeData"
            btnClass="btn-sm" allowClear="true" canSelectRoot="true" canSelectParent="true"/>
          </div>
        </div>
        <div class="form-group">
          <label class="control-label">${text('跟踪预警状态')}：</label>
          <div class="control-inline" style="width: 100px">
            <#form:select name="alarmStatus" blankOption="true" dictType="sys_user_alarmStatus" class="form-control required  " />
          </div>
        </div>
        <div class="form-group" style="width: 13%">
          <label class="control-label">${text('综合心理')}：</label>
          <div class="control-inline" style="width: 52%">
            <#form:select name="psychologyStatus" blankOption="true" dictType="sys_user_psychology" class="form-control required  " />
          </div>
        </div>
        <div class="form-group" style="display: flex;float: right;align-items: center;margin-right: -1px;margin-top: 0px;">
          <div class="form-group" >
            <label class="control-label">${text('测试任务')}：</label>
            <div class="control-inline">
              <#form:input path="testNumberName" maxlength="25" class="form-control"  style="width:89px;"/>
            </div>
          </div>
          <div class="form-group" style="display: none">
            <label class="control-label">${text('测试任务')}：</label>
            <div class="control-inline">
              <#form:input path="testNumber" maxlength="25" class="form-control width-120"/>
            </div>
          </div>
        </#form:form>
  
        <button type="submit" class="btn btn-primary btn-sm" style="margin-top: -9px;"><i class="glyphicon glyphicon-search"></i> ${text('查询')}</button>
        <button type="reset" class="btn btn-default btn-sm isQuick" style="margin-top: -9px;"><i class="glyphicon glyphicon-repeat"></i> ${text('重置')}</button>
        <!--			<button id="untestedPeople" class="btn btn-danger btn-sm" style="margin-top: -9px;"><i class="glyphicon"></i> 未检测人员</button>-->
        <!--			<button id="untestExport" class="btn btn-success btn-sm" style="margin-top: -9px;"><i class="glyphicon glyphicon-export"></i>导出本次报告</button>-->
  
      </div>
  
      <div>
        <div style="text-align: right;margin-right: -9px;margin-bottom: 15px;padding-right: 10px;display: flex;justify-content: end;margin-top: 10px;">
          <button id="untestedPeople" class="btn btn-danger btn-sm"><i class="glyphicon" ></i> 未检测人员</button>
          <button id="untestExport" class="btn btn-success btn-sm"  style="margin-left: 10px;"><i class="glyphicon glyphicon-export" ></i>导出整体报告</button>
          <button id="testExport"  class="btn btn-success btn-sm"  style="margin-left: 10px;"><i class="glyphicon glyphicon-export" ></i>导出excel表格</button>
          <button id="batchExport" class="btn btn-primary btn-sm"  style="margin-left: 10px;"><i class="glyphicon glyphicon-export"></i> 批量导出个人报告</button>
          <button id="batchDelete" class="btn btn-danger btn-sm"  style="margin-left: 10px;"><i class="glyphicon glyphicon-trash"></i> 批量删除个人结果</button>
          <button id="selectAll" class="btn btn-default"  style="margin-left: 10px;">全选</button>
        </div>
        <table id="dataGrid"></table>
        <div id="dataGridPage"></div>
      </div>
    </div>
  </div>
  <div id="panel"></div>
  <div id="login">
    <input type="text" id="userMarking" placeholder="请输入注释" >
    <div id="yesAndNo">
      <button id="yes" class="yesOrNo">确定</button>
      <button id="no" class="yesOrNo">取消</button>
    </div>
  </div>
  <div id="untestedPeopleMask">
    <div id="untestTree" style="color: #dddddd;"></div>
    <div id="untestButton">
      <button id="untestCansel" class="untestButton">关闭</button>
    </div>
  </div>
  
  
  
  
  
  
  <% } %>
  <script src="${ctxStatic}/js/toastr.min.js"></script>
  <link href="${ctxStatic}/css/toastr.min.css" rel="stylesheet">
  <script src="${ctxStatic}/js/sweetalert2.js"></script>
  <script>
    $(document).ready(function() {
  
  
  
      toastr.options = {
        positionClass: 'toast-bottom-right'
      };
      document.getElementById('untestExport').addEventListener('click',function(){
        var testNumberInput = document.querySelector('input[name="testNumber"]');
        var testNumberNameInput = document.querySelector('input[name="testNumberName"]');
        var testNumberValue = testNumberInput.value;
        if(testNumberValue){
  
          // $.ajax({
          // 	url: '${ctx}/subject/allPdfExport/allExportPDF?testNumber=' + testNumberValue,
          // 	// dataType: "json",
          // 	type: "GET",
          // 	error: function () {
          // 		toastr.error('操作失败');
          // 	},
          // 	success: function (dataForm) {
          // 		toastr.success('成功导出！');
          // 	}
          // })
          $(".PreventDuplication").attr("disabled", true).css("pointer-events", "none");
          let xhr = new XMLHttpRequest();
          xhr.open('GET', '${ctx}/subject/allPdfExport/allExportPDF?testNumber=' + testNumberValue, true);
          xhr.responseType = 'blob';
          xhr.onload = function() {
            if (this.status === 200) {
              var blob = new Blob([this.response], { type: 'application/pdf' });
              var link = document.createElement('a');
              link.href = window.URL.createObjectURL(blob);
              link.download = testNumberValue + '-' + '导出报告.pdf';
              link.click();
  
              $(".PreventDuplication").attr("disabled", false).css("pointer-events", "auto");
            }
          };
          xhr.send(null);
          toastr.success('导出成功！嗯')
        }
        else {
          toastr.warning('请选择任务批次')
        }
      })
  
  
      document.getElementById('untestedPeople').addEventListener('click', function(){
        var testNumberInput = document.querySelector('input[name="testNumber"]');
        var testNumberNameInput = document.querySelector('input[name="testNumberName"]');
        var testNumberValue = testNumberInput.value;
        if(testNumberValue){
  
          $.ajax({
            url: '${ctx}/emotion/emotionVideo/findListOfUntestedPersonnel?testnumber='+ testNumberValue,
            type: 'POST',
            dataType: 'json',
            success: function(data) {
              if(data[0]){
                document.querySelector("#panel").style.display="block";
                document.querySelector("#untestedPeopleMask").style.display="block";
                document.body.style.overflow="hidden";
                // 在成功回调函数中处理后端返回的数据
                // 构建表格的 HTML 结构
                var tableHtml = '<table id="maskTable">';
                // 添加表头信息
                tableHtml += '<thead>';
                tableHtml += '<tr>';
                tableHtml += '<th>任务批次</th>';
                tableHtml += '<th>姓名</th>';
                tableHtml += '<th>编号</th>';
                tableHtml += '<th>部别</th>';
                tableHtml += '</tr>';
                tableHtml += '</thead>';
                // 添加表格内容
                tableHtml += '<tbody>';
                // 假设 data 是一个包含表格数据的数组
                data.forEach(function(row, index) {
                  var rowColorClass = (index % 2 === 0) ? 'evenrowcolor' : 'oddrowcolor'; // Determine row color class
                  tableHtml += '<tr class= "'+ rowColorClass +'">';
                  tableHtml += '<td>' + testNumberNameInput.value + '</td>';
                  tableHtml += '<td>' + row.pname + '</td>';
                  tableHtml += '<td>' + row.pidcard + '</td>';
                  tableHtml += '<td>' + row.ppositionName + '</td>';
                  tableHtml += '</tr>';
                });
                tableHtml += '</tbody>';
  
                tableHtml += '</table>';
  
                // 将表格插入到指定的 div 中
                $('#untestTree').html(tableHtml);
              }
              else{
                toastr.success("该任务所有人员均已检测")
              }
  
            },
            error: function(jqXHR, textStatus, errorThrown) {
              console.error('There was a problem with the AJAX operation:', textStatus, errorThrown);
            }
          });
  
  
        }
        else {
          toastr.warning('请选择任务批次')
        }
      })
      document.getElementById('untestCansel').addEventListener('click', function(){
        document.querySelector("#panel").style.display="none";
        document.querySelector("#untestedPeopleMask").style.display="none";
        document.body.style.overflow="visible";
      })
      document.getElementById('testExport').addEventListener('click', function (){
        var testNumberInput = document.querySelector('input[name="testNumber"]');
        var testNumberValue = testNumberInput.value;
        if(testNumberValue){
          $(".PreventDuplication").attr("disabled", true).css("pointer-events", "none");
          let xhr = new XMLHttpRequest();
          xhr.open('GET', '${ctx}/subject/resultExport/taskExportExcel?testNumber=' + testNumberValue, true);
          xhr.responseType = 'blob';
          xhr.onload = function() {
            if (this.status === 200) {
              var blob = new Blob([this.response], { type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });
              var link = document.createElement('a');
              link.href = window.URL.createObjectURL(blob);
              link.download = testNumberValue + '-' + '任务导出报告.xlsx';
              link.click();
              $(".PreventDuplication").attr("disabled", false).css("pointer-events", "auto");
            }
          };
          xhr.send(null);
  // 				$.ajax({
  //     url: '${ctx}/subject/resultExport/taskExportExcel?testNumber=' + testNumberValue,
  //     // dataType: "json",
  //     type: "GET",
  //     error: function () {
  //        toastr.error('操作失败');
  //     },
  //     success: function (dataForm) {
  //        toastr.success('成功导出！');
  //     }
  // })
        }
        else {
          toastr.warning('请选择任务批次')
        }
      })
  
  
  // 批量删除按钮逻辑
      document.getElementById('batchDelete').addEventListener('click', function() {
        var pidcards = Array.from(document.querySelectorAll('.rowCheckbox:checked')).map(cb => cb.id);
        if (pidcards.length === 0) {
          toastr.warning("请选择要删除的行")
          return
        }
        function deleteData(index) {
          if (index < pidcards.length) {
            $.ajax({
              url: '${ctx}/emotion/emotionResult/deleteEmotionResultByVideoId',
              type: 'POST',
              dataType: 'JSON',
              data: {
                'videoIds': pidcards[index]
              },
              success: function(data) {
                deleteData(index + 1); // 递归调用删除下一条数据
                location.reload();
              },
              error: function(jqXHR, textStatus, errorThrown) {
                console.error('There was a problem with the AJAX operation:', textStatus, errorThrown);
              }
            });
          } else {
            toastr.success('所有数据已删除')
          }
        }
        Swal.fire({
          title: '确认要删除选中的人员信息吗？',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: '是的，删除它！',
          cancelButtonText: '取消'
        }).then((result) => {
          if (pidcards.length > 0) {
            deleteData(0); // 开始删除数据
          }
        });
      });
  
  // 批量导出按钮逻辑
      document.getElementById('batchExport').addEventListener('click', async function() {
        var selectedIds = Array.from(document.querySelectorAll('.rowCheckbox:checked')).map(cb => cb.id);
        if (selectedIds.length > 0) {
          for (let i = 0; i < selectedIds.length; i++) {
            await exportFile(selectedIds[i]);
            console.log(selectedIds[i])
          }
        } else {
          toastr.info('请选择要导出的行')
        }
      });
      // 定义一个异步函数来处理文件导出
  
      async function exportFile(videoId) {
        return new Promise((resolve, reject) => {
          $.ajax({
            url: '${ctx}/subject/pdfExport/exportPdfFile?videoId=' + videoId,
            // dataType: "json",
            type: "GET",
            error: function () {
              toastr.error('操作失败');
              reject('下载失败'); // 拒绝 Promise，表示下载过程中出现问题
            },
            success: function (dataForm) {
              toastr.success('成功导出！');
              resolve(); // 解析 Promise，表示文件已成功下载
            }
          })
          // $(".PreventDuplication").attr("disabled", true).css("pointer-events", "none");
          // let xhr = new XMLHttpRequest();
          // xhr.open('GET', '${ctx}/subject/pdfExport/exportPdfFile?videoId=' + videoId, true);
          // xhr.responseType = 'blob';
          // xhr.onload = function() {
          // 	if (this.status === 200) {
          // 		var blob = new Blob([this.response], { type: 'application/pdf' });
          // 		var link = document.createElement('a');
          // 		link.href = window.URL.createObjectURL(blob);
          // 		link.download = videoId + '-' + '导出报告.pdf';
          // 		link.click();
          // 		$(".PreventDuplication").attr("disabled", false).css("pointer-events", "auto");
          // 		resolve(); // 解析 Promise，表示文件已成功下载
          // 	} else {
          // 		reject('下载失败'); // 拒绝 Promise，表示下载过程中出现问题
          // 	}
          // };
          // xhr.onerror = function() {
          // 	reject('网络或服务器错误'); // 拒绝 Promise，表示网络或服务器错误
          // };
          // xhr.send(null);
        });
      }
    });
  
    //# // 初始化DataGrid对象
    $('#dataGrid').dataGrid({
      searchForm: $("#searchForm"),
      columnModel: [
        {header:'${text("编号")}', name:'pidcard', index:'a.pidcard', width:200, align:"left", align:"center",frozen:true},
        {header:'${text("姓名")}', name:'pname', index:'a.pname', width:100, align:"center",},
        {header:'${text("年龄")}', name:'age', index:'a.age', width:80, align:"center"},
        {header:'${text("性别")}', name:'pgender', index:'a.pgender', width:80, align:"center",},
        {header:'${text("部别")}', name:'ppositionName', index:'a.pposition_name', width:150, align:"center",},
        // {header:'${text("建模")}', name:'modelingStatus', index:'a.modeling_status', width:80, align:"center",sortable : false, formatter: function(val, obj, row, act){
        // 		var actions = [];
        // 		actions.push('<a  id="modelingStatus-' + row.mid + '" style=";color: rgb(255,255,255)"></a>&nbsp;');
        // 		return actions.join('');
        // 	}},
        {header:'${text("跟踪预警")}', name:'alarmStatus', index:'a.alarm_status', width:110, align:"center",sortable : false, formatter: function(val, obj, row, act){
            var actions = [];
            actions.push('<a  id="alarmStatus-' + row.mid + '" style=";color: #dddddd"></a>&nbsp;');
            return actions.join('');
          }},
        // {header:'${text("综合心理")}', name:'psychology', index:'a.psychology', width:150, align:"right", formatter: function(val, obj, row, act){
        // 	return js.formatNumber(val, 2, false, ''); // 数值类型格式化 (原始数值, 小数位数, 是否千分位, 默认值，金额情况下设置0.00);
        // }},
        {header:'${text("综合心理")}', name:'psychologyStatus', index:'a.psychology_status', width:110, align:"center",sortable : false, formatter: function(val, obj, row, act){
            var actions = [];
            actions.push('<a  id="psychologyStatus-' + row.mid + '" style=";color: #dddddd"></a>&nbsp;');
            return actions.join('');
          }},
        // {header:'${text("跟踪预警指数")}', name:'tracking', index:'a.tracking', width:150, align:"right", formatter: function(val, obj, row, act){
        // 	return js.formatNumber(val, 2, false, ''); // 数值类型格式化 (原始数值, 小数位数, 是否千分位, 默认值，金额情况下设置0.00);
        // }},
        {header:'${text("测试任务")}', name:'testNumberName', index:'a.test_number_name', width:120,align:"center",},
        {header:'${text("标注")}', name:'annotationType', width:100, align:"center", sortable : false,formatter: function (val, obj, row, act){
            var actions = [];
            actions.push('<a  id="annotationType-' + row.mid + '" style="color: #dddddd" ></a>&nbsp;');
            return actions.join('');
          }},
        {header:'${text("操作")}', name:'action',width:270, align:"center",sortable : false, formatter: function(val, obj, row, act){
            var actions = [];
            actions.push('&nbsp&nbsp;<a href="${ctx}/subject/subjectInformation/form?sid='+row.mid+'&pname='+row.pname+'&age='+row.age+'&ppositionName='+row.ppositionName+'&pidcard='+row.pidcard+'&pgender='+row.pgender+'" class="btnList" style="color:#00f4ff" title="${text("详情")}"><i class="icon-list">详情</i></a>&nbsp;&nbsp;&nbsp;');
            actions.push('<a  id="label-' + row.mid + '" title="${text("标注")}" style="color:#dddddd" ><i class=" icon-note" style="cursor: pointer;" >标注</i></a>&nbsp;&nbsp;&nbsp;');
            actions.push('<a  id="delete-' + row.videoId + '" style="cursor: pointer;color: #d73925" title="${text("删除")}" ><i class="fa fa-trash-o" >删除</i></a>&nbsp;&nbsp;');
            return actions.join('');
          }},
        {header:'${text("添加视频")}', name:'addVideo', width:150, align:"center",sortable : false, formatter: function(val, obj, row, act){
            var actions = [];
            actions.push('<a  id="addVideo-' + row.mid + '" title="${text("添加")}" ><i class="icon-plus" style="cursor: pointer">添加</i></a>&nbsp;');
            return actions.join('');
          }},
        {header:'${text("本地导出")}', name:'exportReport', width:150, align:"center", sortable : false,formatter: function(val, obj, row, act){
            var actions = [];
            actions.push('<a class="PreventDuplication" id="exportInfo-' + row.mid + '" title="${text("本地导出")}" ><i class=" icon-link" style="cursor: pointer">本地导出</i></a>&nbsp;');
            return actions.join('');
          }},
        {header: '${text("选择")}', name: 'select', width: 50, align: 'center', sortable: false, formatter: function(val, obj, row) {
            var actions = [];
            actions.push('<input type="checkbox"  class="rowCheckbox" id= "'+ row.videoId +'">');
            return actions.join('');
          }}
      ],
  
      //# // 加载成功后执行事件
      ajaxSuccess: function(data){
        /**
         * @Description: 全选
         * @Author: lpf
         * @Date: 2024/5/17 10:41
         **/
        var flag = false;//标志位，如果为真，就取消全选
        document.getElementById('selectAll').addEventListener('click', function() {
          for (let i = 0; i < data.list.length; i++) {
            checkbox = document.getElementById(data.list[i].videoId)
            checkbox.checked = true
          }
          if (flag){
            for (let i = 0; i < data.list.length; i++) {
              checkbox = document.getElementById(data.list[i].videoId)
              checkbox.checked = false
            }
          }
          flag = !flag;
        });
  
        for (let i = 0; i < data.list.length; i++) {
          /**
           * @Description: 判断跟踪预警状态
           * @Author: lpf
           * @Date: 2024/5/13 16:12
           **/
          let b = document.getElementById('alarmStatus-' + data.list[i].mid)
          if (data.list[i].alarmStatus === 0){
            b.innerHTML = '未跟踪'
          }else if (data.list[i].alarmStatus === 1) {
            b.innerHTML = '正常'
          }else if (data.list[i].alarmStatus === 2){
            b.innerHTML = '一般'
          }else if (data.list[i].alarmStatus === 3){
            b.innerHTML = '关注'
          }
          /**
           * @Description: 判断综合心理状态
           * @Author: lpf
           * @Date: 2024/5/13 16:18
           **/
          let c = document.getElementById('psychologyStatus-' + data.list[i].mid)
          if (data.list[i].psychologyStatus === 0){
            c.innerHTML = '正常'
            c.style.color = '#03cb6e'
          }else if (data.list[i].psychologyStatus === 1) {
            c.innerHTML = '一般'
            c.style.color = '#c09d00'
          }else if (data.list[i].psychologyStatus === 2){
            c.innerHTML = '关注'
            c.style.color = '#f37c01'
          }
          /**
           * @Description: 删除信息
           * @Author: lpf
           * @Date: 2024/5/14 15:14
           **/
          var deleteElement = document.getElementById('delete-' + data.list[i].videoId)
          deleteElement.addEventListener('click', function (){
            Swal.fire({
              title: '确认要删除' + data.list[i].pname + '的人员信息吗？',
              text: "此操作不可撤销",
              icon: 'warning',
              showCancelButton: true,
              confirmButtonColor: '#3085d6',
              cancelButtonColor: '#d33',
              confirmButtonText: '是的，删除它！',
              cancelButtonText: '取消'
            }).then((result) => {
              if (result.isConfirmed) {
                $.ajax({
                  url: '${ctx}/emotion/emotionVideo/deleteRelevantInformationByVideoId',
                  type: 'POST',
                  // contentType: 'application/json',
                  data: {
                    'videoIds':data.list[i].videoId
                  },
                  success: function(data) {
                    $('#dataGrid').dataGrid('reloadGrid');
                  },
                  error: function(jqXHR, textStatus, errorThrown) {
                    console.error('There was a problem with the AJAX operation:', textStatus, errorThrown);
                  }
                });
              }
            });
          })
  
          /**
           * @Description: 添加标注
           * @Author: lpf
           * @Date: 2024/5/13 16:35
           **/
          var annotateElement = document.getElementById('label-' + data.list[i].mid);
          annotateElement.addEventListener('click', function() {
            //调出之前的标注，在那个的基础上修改
            // 在这里编写处理点击事件的逻辑，例如显示模态框或执行其他操作
            ///////////////////////duduudududud////////////////////
            //上面还把注释按钮的id从sid改成了pidcard
            //1.1显示面板和蒙版
            document.querySelector("#panel").style.display="block";
            document.querySelector("#login").style.display="block";
            //当出现蒙版时,去除body的滚动条
            document.body.style.overflow="hidden";
            document.getElementById('userMarking').value = data.list[i].annotation;
            //2.点击文档
            document.onclick=function (event) {
              var e=event||window.event;
              //2.1获取点击的标签
              var targetId=e.target?e.target.id:e.srcElement.id;
              if(targetId =='no'){
                document.querySelector("#panel").style.display="none";
                document.querySelector("#login").style.display="none";
                //当出现蒙版时,去除body的滚动条
                document.body.style.overflow="visible";
              }
            };
            // 2. 监听确定按钮的点击
            document.querySelector("#yes").onclick = function() {
              // 获取输入框的值
              //定义一遍身份证和注释
              var pidcard = data.list[i].pidcard;
              var userMessage = document.getElementById('userMarking').value;
              // 创建一个要发送的对象
              // 发送请求到后端
              $.ajax({
                url: '${ctx}/subject/subjectInformation/updateAnnotationInfo?pidCard=' + pidcard + '&annotation=' + userMessage + '&annotationType=1',
                type: 'POST',
                contentType: 'application/xml',
                success: function(data) {
                  location.reload();
                  toastr.success("上传成功!")
                  $("#panel").hide();
                  $("#login").hide();
                  $("body").css("overflow", "visible");
  
                },
                error: function(jqXHR, textStatus, errorThrown) {
                  console.error('There was a problem with the AJAX operation:', textStatus, errorThrown);
                }
              });
            };
            /////////////////////dudududududududu////////////////////
          });
  
          /**
           * @Description: 判断有无标注信息
           * @Author: lpf
           * @Date: 2024/5/13 17:21
           **/
  
          let d = document.getElementById('annotationType-' + data.list[i].mid);
          if (data.list[i].annotation) {
            d.innerHTML = '已标注';
            d.addEventListener('mouseover', function(event) {
              let tooltip = document.createElement('div');
              tooltip.textContent = data.list[i].annotation;
              tooltip.style.position = 'absolute';
              // 获取当前 div 的位置和尺寸
              let rect = d.getBoundingClientRect();
              let dWidth = rect.width;
              let dHeight = rect.height;
              // 设置 tooltip 的位置为当前 div 的右下角
              tooltip.style.top = rect.top + dHeight + 'px';
              tooltip.style.left = rect.left + dWidth + 'px';
              tooltip.style.backgroundColor = '#f0f0f0';
              tooltip.style.padding = '5px';
              tooltip.style.border = '1px solid #ccc';
              document.body.appendChild(tooltip);
              d.addEventListener('mouseout', function() {
                document.body.removeChild(tooltip);
              });
            });
          } else {
            d.innerHTML = '未标注';
          }
  
  
  
          /**
           * @Description: 添加视频
           * @Author: lpf
           * @Date: 2024/5/13 17:26
           **/
              // 获取添加视频标签的元素
          var addVideoElement = document.getElementById('addVideo-' + data.list[i].mid);
          addVideoElement.addEventListener('click', function() {
            var fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.setAttribute('multiple', '');
            fileInput.addEventListener('change', function() {
              var files = fileInput.files; // 这是一个文件数组，包含所有选中的文件
              var formData = new FormData();
              var filteredFiles = Array.from(files).filter(file => file.name.includes('红外'));
              var filteredFiles2 = Array.from(files).filter(file => file.name.includes('正常'));
              // 将所有文件添加到FormData对象中
              filteredFiles.forEach(file => {
                formData.append('nirVideoFile', file, file.name);
              });
              filteredFiles2.forEach(file => {
                formData.append('videoFile', file, file.name);
              });
              // 添加其他表单数据
              formData.append('videoId', data.list[i].videoId);
              formData.append('pidCard', data.list[i].pidcard);
              formData.append('pname', data.list[i].pname);
              formData.append('testNumber', data.list[i].testNumber);
  
              $.ajax({
                url: '${ctx}/emotion/emotionVideo/updateOrInsertVideoByPidCard',
                type: 'POST',
                contentType: false, // 不设置内容类型
                processData: false, // 不处理数据
                data: formData,
                success: function(response) {
                  toastr.success("上传成功!")
                },
                error: function(jqXHR, textStatus, errorThrown) {
                  toastr.error("上传失败!")
                }
              });
            });
  
            // 触发文件选择
            fileInput.click();
          });
          /**
           * @Description: 导出报告
           * @Author: lpf
           * @Date: 2024/5/15 16:08
           **/
              //导出报告
          var exportInfoElement = document.getElementById('exportInfo-' + data.list[i].mid )
          // 添加点击事件监听器
          exportInfoElement.addEventListener('click', function () {
            // document.getElementById('exportInfo-' + data.list[i].mid ).innerHTML = '<i class=" icon-refresh" style="cursor: pointer">正在导出</i>'
            // // 禁用超链接防止重复提交下载 disabled和events必须一起使用
            // $(".PreventDuplication").attr("disabled",true).css("pointer-events","none");
            // let xhr = new XMLHttpRequest();
            // xhr.open('POST', '${ctx}/subject/pdfExport/exportPdfFile?videoId='+ data.list[i].videoId, true);
            // xhr.responseType = 'blob';
            // // 处理响应结果
            // xhr.onload = function() {
            // 	if (this.status === 200) {
            // 		var blob = new Blob([this.response], { type: 'application/pdf' });
            // 		var link = document.createElement('a');
            // 		link.href = window.URL.createObjectURL(blob);
            // 		link.download = data.list[i].pidcard+'-'+data.list[i].pname+ '-'+  '导出报告.pdf';
            // 		link.click();
            // 		//下载完成恢复超链接
            // 		$(".PreventDuplication").attr("disabled",false).css("pointer-events","auto");
            // 		setTimeout(function () {
            // 			document.getElementById('exportInfo-' + data.list[i].mid ).innerHTML = '<i class=" icon-link" style="cursor: pointer">导出报告</i>'
            // 		},1100)
            // 		document.getElementById('exportInfo-' + data.list[i].mid ).innerHTML = '<i class=" icon-link" id="fade" style="cursor: pointer">导出成功</i>'
            // 		$('#fade').fadeOut(1000)
            // 	}
            // };
            // xhr.send(null);
            $.ajax({
              url: '${ctx}/subject/pdfExport/exportPdfFile?videoId='+ data.list[i].videoId,
              // dataType: "json",
              type: "POST",
              error: function () {
                toastr.error('操作失败');
              },
              success: function (dataForm) {
                toastr.success('成功导出！');
              }
            })
          })
        }
      }
    });
    $('#dataGrid').dataGrid('hideCol', 'addVideo'); //默认不显示添加视频那一列
  </script>